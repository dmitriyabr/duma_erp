# –°–∫—Ä–∏–ø—Ç—ã –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è ERP

## reset_invoices.py

–°–∫—Ä–∏–ø—Ç –¥–ª—è –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ—Ö —Å—á–µ—Ç–æ–≤ (invoices) –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø–ª–∞—Ç–µ–∂–µ–π (payments).

### üöÄ TL;DR - –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

**–°–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–± (—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏):**
```bash
# –ó–∞–ø—É—Å—Ç–∏ wrapper —Å–∫—Ä–∏–ø—Ç - –æ–Ω –≤—Å–µ —Å–¥–µ–ª–∞–µ—Ç –∑–∞ —Ç–µ–±—è
./scripts/reset_invoices_railway.sh
```

**–ò–ª–∏ –≤—Ä—É—á–Ω—É—é:**
```bash
# 1. –°–æ–∑–¥–∞–π backup –≤ Railway Dashboard (Database ‚Üí Backups ‚Üí Create Backup)

# 2. –ü–æ–¥–∫–ª—é—á–∏—Å—å –∫ –ø—Ä–æ–µ–∫—Ç—É
railway link

# 3. –°–Ω–∞—á–∞–ª–∞ dry-run
railway run python scripts/reset_invoices.py --dry-run

# 4. –ï—Å–ª–∏ –≤—Å–µ –æ–∫ - –≤—ã–ø–æ–ª–Ω–∏
railway run python scripts/reset_invoices.py --confirm
# –í–≤–µ–¥–∏ "DELETE ALL INVOICES" –∫–æ–≥–¥–∞ –ø–æ–ø—Ä–æ—Å–∏—Ç

# 5. –ì–æ—Ç–æ–≤–æ! –í—Å–µ —Å—á–µ—Ç–∞ —É–¥–∞–ª–µ–Ω—ã, –ø–ª–∞—Ç–µ–∂–∏ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
```

### –ß—Ç–æ –¥–µ–ª–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç

**–£–¥–∞–ª—è–µ—Ç:**
- ‚ùå –í—Å–µ Invoices –∏ InvoiceLines
- ‚ùå –í—Å–µ Reservations –∏ ReservationItems
- ‚ùå –í—Å–µ CreditAllocations

**–ù–ï —É–¥–∞–ª—è–µ—Ç:**
- ‚úÖ Payments (–æ—Å—Ç–∞—é—Ç—Å—è –∫–∞–∫ –±–∞–ª–∞–Ω—Å —Å—Ç—É–¥–µ–Ω—Ç–æ–≤)
- ‚úÖ Students, Users, Terms –∏ –¥—Ä—É–≥–∏–µ –¥–∞–Ω–Ω—ã–µ
- ‚úÖ AuditLogs (–∏—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π)

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–∞ Railway

#### –í–∞—Ä–∏–∞–Ω—Ç 1: –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ Railway CLI (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```bash
# 1. –ü–æ–¥–∫–ª—é—á–∏—Å—å –∫ –ø—Ä–æ–µ–∫—Ç—É (–µ—Å–ª–∏ –µ—â–µ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω)
railway link

# 2. –°–Ω–∞—á–∞–ª–∞ dry-run –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
railway run python scripts/reset_invoices.py --dry-run

# 3. –ï—Å–ª–∏ –≤—Å–µ –û–ö - —Ä–µ–∞–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
railway run python scripts/reset_invoices.py --confirm
```

#### –í–∞—Ä–∏–∞–Ω—Ç 2: –ó–∞–ø—É—Å–∫ –ª–æ–∫–∞–ª—å–Ω–æ —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ –ø—Ä–æ–¥—É

```bash
# 1. –ü–æ–ª—É—á–∏ DATABASE_URL –∏–∑ Railway
railway variables

# 2. –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π DATABASE_URL –≤ —Ç–µ–∫—É—â—É—é —Å–µ—Å—Å–∏—é
export DATABASE_URL="postgresql+asyncpg://..."

# 3. –ó–∞–ø—É—Å—Ç–∏ —Å–∫—Ä–∏–ø—Ç –ª–æ–∫–∞–ª—å–Ω–æ
python scripts/reset_invoices.py --dry-run
python scripts/reset_invoices.py --confirm
```

#### –í–∞—Ä–∏–∞–Ω—Ç 3: –ß–µ—Ä–µ–∑ Railway Shell (–∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ)

```bash
# –û—Ç–∫—Ä–æ–π shell –Ω–∞ Railway
railway shell

# –í–Ω—É—Ç—Ä–∏ shell –∑–∞–ø—É—Å—Ç–∏ —Å–∫—Ä–∏–ø—Ç
python scripts/reset_invoices.py --dry-run
python scripts/reset_invoices.py --confirm
```

### ‚ö†Ô∏è –í–ê–ñ–ù–û

1. **–°–¥–µ–ª–∞–π—Ç–µ backup –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ü–ï–†–ï–î –∑–∞–ø—É—Å–∫–æ–º!**

   **–ß–µ—Ä–µ–∑ Railway Dashboard (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è):**
   - –ó–∞–π–¥–∏ –≤ Railway Dashboard ‚Üí —Ç–≤–æ–π –ø—Ä–æ–µ–∫—Ç ‚Üí Database (Postgres)
   - –ü–µ—Ä–µ–π–¥–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É **Backups**
   - –ù–∞–∂–º–∏ **Create Backup** - Railway —Å–æ–∑–¥–∞—Å—Ç snapshot
   - –ú–æ–∂–Ω–æ —Å–∫–∞—á–∞—Ç—å backup —á–µ—Ä–µ–∑ **Download** –µ—Å–ª–∏ –Ω—É–∂–Ω–æ

   **–ß–µ—Ä–µ–∑ Railway CLI (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞):**
   ```bash
   # –ü–æ–¥–∫–ª—é—á–∏—Å—å –∫ Railway –ø—Ä–æ–µ–∫—Ç—É
   railway link

   # –°–æ–∑–¥–∞–π backup —á–µ—Ä–µ–∑ Railway
   railway run pg_dump $DATABASE_URL -F c -f backup_before_reset_$(date +%Y%m%d_%H%M%S).dump
   ```

2. **–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª .env –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ** - —Å–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `DATABASE_URL` –∏–∑ .env

3. **–≠—Ç–æ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è** - –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è —Å—á–µ—Ç–∞ –Ω–µ–ª—å–∑—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å

### –ü—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞

```
======================================================================
–°–ö–†–ò–ü–¢ –£–î–ê–õ–ï–ù–ò–Ø –°–ß–ï–¢–û–í (RESET INVOICES)
======================================================================

üåç –û–∫—Ä—É–∂–µ–Ω–∏–µ: production
üóÑÔ∏è  –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: localhost:5432/school_erp
üîß –†–µ–∂–∏–º: –†–ï–ê–õ–¨–ù–û–ï –í–´–ü–û–õ–ù–ï–ù–ò–ï

üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:
  - invoices: 45 –∑–∞–ø–∏—Å–µ–π
  - invoice_lines: 123 –∑–∞–ø–∏—Å–µ–π
  - credit_allocations: 89 –∑–∞–ø–∏—Å–µ–π
  - reservations: 12 –∑–∞–ø–∏—Å–µ–π
  - reservation_items: 34 –∑–∞–ø–∏—Å–µ–π

‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è —É–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...

1Ô∏è‚É£  –£–¥–∞–ª–µ–Ω–∏–µ Reservations...
   ‚úì –£–¥–∞–ª–µ–Ω–æ: 12 reservations

2Ô∏è‚É£  –£–¥–∞–ª–µ–Ω–∏–µ CreditAllocations...
   ‚úì –£–¥–∞–ª–µ–Ω–æ: 89 credit allocations

3Ô∏è‚É£  –£–¥–∞–ª–µ–Ω–∏–µ Invoices...
   ‚úì –£–¥–∞–ª–µ–Ω–æ: 45 invoices

======================================================================
‚úÖ –£–°–ü–ï–®–ù–û –£–î–ê–õ–ï–ù–û
======================================================================

üéâ –í—Å–µ —Å—á–µ—Ç–∞ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω—ã!
üí∞ –í—Å–µ payments —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –∏ —Ç–µ–ø–µ—Ä—å —è–≤–ª—è—é—Ç—Å—è –±–∞–ª–∞–Ω—Å–æ–º —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
```

### –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ backup (–µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫)

#### –ß–µ—Ä–µ–∑ Railway Dashboard
1. –ó–∞–π–¥–∏ –≤ Railway Dashboard ‚Üí Database ‚Üí Backups
2. –ù–∞–π–¥–∏ –Ω—É–∂–Ω—ã–π backup (—Å–æ–∑–¥–∞–Ω–Ω—ã–π –¥–æ –∑–∞–ø—É—Å–∫–∞ —Å–∫—Ä–∏–ø—Ç–∞)
3. –ù–∞–∂–º–∏ **Restore** - Railway –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç –ë–î

#### –ß–µ—Ä–µ–∑ Railway CLI (–µ—Å–ª–∏ —Å–∫–∞—á–∞–ª dump –ª–æ–∫–∞–ª—å–Ω–æ)
```bash
# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ dump —Ñ–∞–π–ª–∞
railway run pg_restore -d $DATABASE_URL -c -v backup_before_reset.dump

# –ò–ª–∏ –º–æ–∂–Ω–æ —á–µ—Ä–µ–∑ psql
railway run psql $DATABASE_URL < backup_before_reset.sql
```

#### –í–∞–∂–Ω–æ
- Railway –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç daily backups
- Backups —Ö—Ä–∞–Ω—è—Ç—Å—è 7-30 –¥–Ω–µ–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–ª–∞–Ω–∞
- Manual backups –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è
