<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Invoice {{ invoice.invoice_number }}</title>
    <style>
        @page { size: A4; margin: 12mm 12mm; }
        body { font-family: Arial, sans-serif; font-size: 9pt; line-height: 1.3; color: #000; }
        .header { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 2px solid #1E40AF; padding-bottom: 6px; }
        .logo { width: 120px; max-height: 55px; object-fit: contain; }
        .school-info { font-size: 9pt; margin-top: 4px; }
        .invoice-info { text-align: right; }
        .invoice-title { font-size: 18pt; font-weight: bold; color: #1E40AF; }
        .invoice-number { font-size: 12pt; font-weight: bold; }
        .section { margin: 8px 0; padding: 6px 8px; border: 1px solid #E5E7EB; }
        .bill-to { display: flex; justify-content: space-between; gap: 15px; }
        .bill-to-left { flex: 1; }
        .bill-to-right { text-align: right; }
        table { width: 100%; border-collapse: collapse; margin: 8px 0; font-size: 9pt; }
        th { background-color: #F3F4F6; padding: 5px 6px; text-align: left; border-bottom: 2px solid #D1D5DB; }
        td { padding: 4px 6px; border-bottom: 1px solid #E5E7EB; }
        .amount { text-align: right; }
        .totals { margin-left: auto; width: 260px; margin-top: 4px; }
        .totals-row { display: flex; justify-content: space-between; padding: 2px 0; }
        .total-due { font-size: 12pt; font-weight: bold; color: #059669; border-top: 2px solid #000; padding-top: 6px; margin-top: 6px; }
        .discount { color: #DC2626; }
        .payment-box { background-color: #DBEAFE; padding: 8px 10px; border-radius: 4px; margin: 8px 0; font-size: 8pt; }
        .footer { margin-top: 10px; font-size: 8pt; color: #6B7280; border-top: 1px solid #E5E7EB; padding-top: 6px; }
    </style>
</head>
<body>
    <div class="header">
        <div>
            {% if logo_data_uri %}<img src="{{ logo_data_uri }}" alt="School Logo" class="logo">{% endif %}
            <div class="school-info">
                {% if school_info.name %}<strong>{{ school_info.name }}</strong><br>{% endif %}
                {% if school_info.address %}{{ school_info.address }}<br>{% endif %}
                {% if school_info.phone %}Tel: {{ school_info.phone }}<br>{% endif %}
                {% if school_info.email %}Email: {{ school_info.email }}{% endif %}
            </div>
        </div>
        <div class="invoice-info">
            <div class="invoice-title">INVOICE</div>
            <div class="invoice-number">#{{ invoice.invoice_number }}</div>
            <div>Date: {{ (invoice.issue_date or invoice.created_at).strftime('%d %b %Y') if (invoice.issue_date or invoice.created_at) else '' }}</div>
            {% if invoice.due_date %}<div>Due: {{ invoice.due_date.strftime('%d %b %Y') }}</div>{% endif %}
        </div>
    </div>

    <div class="section bill-to">
        <div class="bill-to-left">
            <strong>BILL TO:</strong><br>
            Student: {{ invoice.student.full_name }}<br>
            Admission #: {{ invoice.student.student_number }}<br>
            Parent: {{ invoice.student.guardian_name }}<br>
            Phone: {{ invoice.student.guardian_phone }}
        </div>
        <div class="bill-to-right">
            {% if invoice.term.display_name %}<strong>TERM:</strong> {{ invoice.term.display_name }}<br>{% endif %}
            {% if invoice.term.academic_year %}Academic Year: {{ invoice.term.academic_year }}<br>{% endif %}
            {% if invoice.student.grade %}<strong>CLASS:</strong> {{ invoice.student.grade }}{% endif %}
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th>DESCRIPTION</th>
                <th style="width: 80px;">QTY</th>
                <th style="width: 120px;" class="amount">UNIT PRICE</th>
                <th style="width: 120px;" class="amount">AMOUNT</th>
            </tr>
        </thead>
        <tbody>
            {% for line in invoice.lines %}
            <tr>
                <td>{{ line.description }}</td>
                <td>{{ line.quantity }}</td>
                <td class="amount">{{ "{:,.0f}".format(line.unit_price) }}</td>
                <td class="amount">{{ "{:,.0f}".format(line.line_total) }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="totals">
        <div class="totals-row">
            <span>SUBTOTAL:</span>
            <span>{{ "{:,.0f}".format(invoice.subtotal) }} KES</span>
        </div>
        {% if invoice.discount_total > 0 %}
        <div class="totals-row discount">
            <span>Discount:</span>
            <span>-{{ "{:,.0f}".format(invoice.discount_total) }} KES</span>
        </div>
        {% endif %}
        <div class="totals-row total-due">
            <span>TOTAL DUE:</span>
            <span>{{ "{:,.0f}".format(invoice.total) }} KES</span>
        </div>
    </div>

    <div class="section">
        <strong>PAYMENT STATUS:</strong><br>
        Paid to Date: {{ "{:,.0f}".format(invoice.paid_total) }} KES<br>
        Balance Due: {{ "{:,.0f}".format(invoice.amount_due) }} KES
    </div>

    {% if mpesa_info or bank_info %}
    <div class="payment-box">
        <strong>PAYMENT INSTRUCTIONS:</strong><br><br>
        {% if mpesa_info %}
        <strong>M-Pesa Paybill:</strong><br>
        Paybill: {{ mpesa_info.business_number }}<br>
        Account Number: {{ mpesa_info.account_number }}<br>
        Amount: {{ "{:,.0f}".format(invoice.total) }} KES<br><br>
        {% endif %}
        {% if bank_info %}
        <strong>Bank Transfer:</strong><br>
        Bank: {{ bank_info.bank_name }}<br>
        Account Name: {{ bank_info.account_name }}<br>
        Account Number: {{ bank_info.account_number }}<br>
        {% if bank_info.branch %}Branch: {{ bank_info.branch }}<br>{% endif %}
        {% if bank_info.swift_code %}Swift Code: {{ bank_info.swift_code }}<br>{% endif %}
        <br>
        {% endif %}
        <em>Please use Invoice Number as reference: {{ invoice.invoice_number }}</em>
    </div>
    {% endif %}

    <div class="footer">
        Page 1 of 1 | Generated: {{ generated_at.strftime('%d %b %Y %H:%M') if generated_at else '' }} | School ERP
    </div>
</body>
</html>
